<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor NASA</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0b0b;
      color: #f0f0f0;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    #sidebar {
      width: 300px;
      background: #111;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
    }
    #main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #canvasContainer {
      position: relative;
      width: 80vh;
      height: 80vh;
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      width: 100%;
      height: 100%;
      cursor: grab;
      background: #000;
    }
    h1 {
      margin-top: 0;
      text-align: center;
    }
    button {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background: #2979ff;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #5393ff;
    }
    .control-group {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-top: 10px;
    }
    input[type=range] {
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>Editor NASA</h1>
    <input type="file" id="fileInput" accept="image/*" multiple>
    <button id="prevBtn">⬅️ Anterior</button>
    <button id="nextBtn">Siguiente ➡️</button>
    <button id="resetBtn">Reiniciar</button>
    <button id="downloadBtn">Descargar Actual</button>
    <button id="downloadAllBtn">Descargar Todas</button>

    <div class="control-group"><label>Brillo</label><input type="range" id="brightness" min="0" max="2" step="0.01" value="1"></div>
    <div class="control-group"><label>Contraste</label><input type="range" id="contrast" min="0" max="2" step="0.01" value="1"></div>
    <div class="control-group"><label>Saturación</label><input type="range" id="saturation" min="0" max="2" step="0.01" value="1"></div>
    <div class="control-group"><label>Nitidez</label><input type="range" id="sharpness" min="0" max="1" step="0.01" value="0"></div>
    <div class="control-group"><label>Viñeta</label><input type="range" id="vignette" min="0" max="1" step="0.01" value="0"></div>
    <div class="control-group"><label>Zoom</label><input type="range" id="zoom" min="0.5" max="3" step="0.01" value="1"></div>
  </div>

  <div id="main">
    <div id="canvasContainer">
      <canvas id="editorCanvas" width="1080" height="1080"></canvas>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    const FRAME_SRC = 'nasa.png'; // Coloca nasa.png en la misma carpeta que este HTML

    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');

    const fileInput = document.getElementById('fileInput');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');

    const brightness = document.getElementById('brightness');
    const contrast = document.getElementById('contrast');
    const saturation = document.getElementById('saturation');
    const sharpness = document.getElementById('sharpness');
    const vignette = document.getElementById('vignette');
    const zoom = document.getElementById('zoom');

    let images = [];
    let currentIndex = 0;
    let frameImage = new Image();
    frameImage.src = FRAME_SRC;

    let offsetX = 0;
    let offsetY = 0;
    let isDragging = false;
    let startX, startY;

    const defaultFilters = {
      brightness: 1,
      contrast: 1,
      saturation: 1,
      sharpness: 0,
      vignette: 0,
      zoom: 1,
      offsetX: 0,
      offsetY: 0
    };

    fileInput.addEventListener('change', (e) => {
      images = [];
      const files = e.target.files;
      for (let i = 0; i < files.length; i++) {
        const img = new Image();
        img.onload = () => {
          images.push({ img: img, filters: { ...defaultFilters } });
          if (images.length === files.length) {
            currentIndex = 0;
            loadFilters();
            draw();
          }
        };
        img.src = URL.createObjectURL(files[i]);
      }
    });

    prevBtn.addEventListener('click', () => {
      if (images.length > 0) {
        saveFilters();
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        loadFilters();
        draw();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (images.length > 0) {
        saveFilters();
        currentIndex = (currentIndex + 1) % images.length;
        loadFilters();
        draw();
      }
    });

    resetBtn.addEventListener('click', () => {
      if (images.length > 0) {
        images[currentIndex].filters = { ...defaultFilters };
        loadFilters();
        draw();
      }
    });

    function saveFilters() {
      if (images.length > 0) {
        images[currentIndex].filters = {
          brightness: parseFloat(brightness.value),
          contrast: parseFloat(contrast.value),
          saturation: parseFloat(saturation.value),
          sharpness: parseFloat(sharpness.value),
          vignette: parseFloat(vignette.value),
          zoom: parseFloat(zoom.value),
          offsetX: offsetX,
          offsetY: offsetY
        };
      }
    }

    function loadFilters() {
      if (images.length > 0) {
        const f = images[currentIndex].filters;
        brightness.value = f.brightness;
        contrast.value = f.contrast;
        saturation.value = f.saturation;
        sharpness.value = f.sharpness;
        vignette.value = f.vignette;
        zoom.value = f.zoom;
        offsetX = f.offsetX;
        offsetY = f.offsetY;
      }
    }

    [brightness, contrast, saturation, sharpness, vignette, zoom].forEach(input => {
      input.addEventListener('input', draw);
    });

    canvas.addEventListener('mousedown', (e) => {
      isDragging = true;
      canvas.style.cursor = 'grabbing';
      startX = e.offsetX;
      startY = e.offsetY;
    });

    canvas.addEventListener('mouseup', () => {
      isDragging = false;
      canvas.style.cursor = 'grab';
      saveFilters();
    });

    canvas.addEventListener('mousemove', (e) => {
      if (isDragging) {
        offsetX += e.offsetX - startX;
        offsetY += e.offsetY - startY;
        startX = e.offsetX;
        startY = e.offsetY;
        draw();
      }
    });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (images.length === 0) return;
      const imgObj = images[currentIndex];
      const f = {
        brightness: parseFloat(brightness.value),
        contrast: parseFloat(contrast.value),
        saturation: parseFloat(saturation.value),
        sharpness: parseFloat(sharpness.value),
        vignette: parseFloat(vignette.value),
        zoom: parseFloat(zoom.value)
      };

      ctx.save();
      ctx.translate(canvas.width / 2 + offsetX, canvas.height / 2 + offsetY);
      ctx.scale(f.zoom, f.zoom);
      ctx.filter = `brightness(${f.brightness}) contrast(${f.contrast}) saturate(${f.saturation})`;
      const iw = imgObj.img.width;
      const ih = imgObj.img.height;
      const scale = Math.min(canvas.width / iw, canvas.height / ih);
      ctx.drawImage(imgObj.img, -iw / 2, -ih / 2, iw, ih);
      ctx.restore();

      ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);

      if (f.vignette > 0) {
        const grd = ctx.createRadialGradient(
          canvas.width / 2,
          canvas.height / 2,
          canvas.width / 2 * (1 - f.vignette),
          canvas.width / 2,
          canvas.height / 2,
          canvas.width / 2
        );
        grd.addColorStop(0, 'rgba(0,0,0,0)');
        grd.addColorStop(1, `rgba(0,0,0,${f.vignette})`);
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    function exportCurrent() {
      draw();
      const dataURL = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataURL;
      a.download = `imagen_editada_${currentIndex + 1}.png`;
      a.click();
    }

    async function exportAll() {
      if (images.length === 0) return;
      const zip = new JSZip();

      for (let i = 0; i < images.length; i++) {
        currentIndex = i;
        loadFilters();
        draw();
        const dataURL = canvas.toDataURL('image/png');
        const base64 = dataURL.split(',')[1];
        zip.file(`imagen_editada_${i + 1}.png`, base64, { base64: true });
      }

      const content = await zip.generateAsync({ type: 'blob' });
      saveAs(content, 'imagenes_editadas.zip');
      loadFilters();
      draw();
    }

    downloadBtn.addEventListener('click', exportCurrent);
    downloadAllBtn.addEventListener('click', exportAll);

    frameImage.onload = draw;
  </script>
</body>
</html>
